@model IEnumerable<ConsultorioVerde.Web.Models.CitaViewModel>

<style>
    .text-verde {
        color: #208b3a;
    }

    .btn-verde {
        background-color: #208b3a;
        color: white;
    }

        .btn-verde:hover {
            background-color: #1a7431;
            color: white;
        }

    .border-verde-subtle {
        border-color: #208b3a44;
    }
    /* Clase para dar aire a las etiquetas */
    .label-filter {
        font-size: 0.75rem;
        letter-spacing: 0.05rem;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-verde fw-bold"><i class="bi bi-calendar-event me-2"></i>Agenda de Citas Médicas</h2>
    <a asp-action="Programar" class="btn btn-verde shadow-sm">
        <i class="bi bi-plus-lg"></i> Agendar Nueva Cita
    </a>
</div>

@* Bloque de Búsqueda y Filtros Organizado *@
<div class="card shadow-sm border-0 mb-4 bg-light">
    <div class="card-body p-4">
        <form asp-action="Index" method="get">
            <div class="row g-3">
                @* Primera Fila: Búsqueda por Texto *@
                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted label-filter">BUSCAR POR:</label>
                    <select name="filtro" class="form-select border-verde-subtle">
                        <option value="Nombre Médico" selected="@(ViewBag.Filtro == "Nombre Médico")">Nombre Médico</option>
                        <option value="Nombre Paciente" selected="@(ViewBag.Filtro == "Nombre Paciente")">Nombre Paciente</option>
                        <option value="Estado" selected="@(ViewBag.Filtro == "Estado")">Estado</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label fw-bold text-muted label-filter">BUSCAR:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-success"></i></span>
                        <input type="text" name="buscar" class="form-control border-start-0"
                               placeholder="Escriba aquí o deje vacío para ver todos" value="@ViewBag.Buscar">
                    </div>
                </div>

                @* Segunda Fila: Filtros de Fecha *@
                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted label-filter">FECHA INICIO:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-calendar-range text-success"></i></span>
                        <input type="date" name="fechaInicio" class="form-control border-start-0 border-verde-subtle"
                               value="@ViewBag.FechaInicio"> @* <-- Aquí se setea *@
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted label-filter">FECHA FIN:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-calendar-range-fill text-success"></i></span>
                        <input type="date" name="fechaFin" class="form-control border-start-0 border-verde-subtle"
                               value="@ViewBag.FechaFin"> @* <-- Aquí se setea *@
                    </div>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="btn-group w-100 shadow-sm">
                        <button type="submit" class="btn btn-verde">
                            <i class="bi bi-funnel-fill me-1"></i> Aplicar Filtros
                        </button>
                      @*   <a asp-action="Index" class="btn btn-outline-secondary" title="Limpiar">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </a> *@
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th class="ps-4">Fecha y Hora</th>
                    <th>Paciente</th>
                    <th>Médico</th>
                    <th>Motivo</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center pe-4">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        bool esFinalizada = item.Estado?.ToLower() == "completada" || item.Estado?.ToLower() == "cancelada";
                        string claseDeshabilitado = esFinalizada ? "disabled opacity-50" : "";

                        <tr>
                            <td class="fw-bold ps-4">
                                @(item.FechaCita.HasValue? item.FechaCita.Value.ToString("dd/MM/yyyy hh:mm tt") : "N/A")
                            </td>
                            <td><i class="bi bi-person me-1 text-secondary"></i> @item.NombrePaciente</td>
                            <td><i class="bi bi-person-badge me-1 text-secondary"></i> @item.NombreMedico</td>
                            <td class="small text-truncate" style="max-width: 200px;" title="@item.Motivo">@item.Motivo</td>
                            <td class="text-center">
                                @switch (item.Estado?.ToLower())
                                {
                                    case "pendiente":
                                        <span class="badge bg-warning text-dark shadow-sm">Pendiente</span>
                                        break;
                                    case "completada":
                                        <span class="badge bg-info shadow-sm">Completada</span>
                                        break;
                                    case "cancelada":
                                        <span class="badge bg-danger shadow-sm">Cancelada</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary shadow-sm">@item.Estado</span>
                                        break;
                                }
                            </td>
                            <td class="text-center pe-4">
                                <div class="btn-group shadow-sm">
                                    <a asp-action="Editar"
                                       asp-route-id="@item.IdCita"
                                       class="btn btn-sm btn-outline-primary @claseDeshabilitado"
                                       title="Editar Cita">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    @if (User.IsInRole("Medico") || User.IsInRole("Admin"))
                                    {
                                        if (esFinalizada)
                                        {
                                            <button type="button" class="btn btn-sm btn-success text-white opacity-50" disabled>
                                                <i class="bi bi-stethoscope me-1"></i> Atender
                                            </button>
                                        }
                                        else
                                        {
                                            <a asp-action="Atender"
                                               asp-route-id="@item.IdCita"
                                               class="btn btn-sm btn-success text-white @claseDeshabilitado"
                                               title="Atender Paciente">
                                                <i class="bi bi-stethoscope me-1"></i> Atender
                                            </a>
                                        }
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-calendar-x h1 d-block mb-3 text-muted"></i>
                            <p class="text-muted">No se encontraron citas con los filtros aplicados.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Leemos el ID desde el TempData de C#
            var idConsulta = '@TempData["ConsultaGuardadaId"]';

            // Si hay un ID, significa que acabamos de guardar una consulta
            if (idConsulta && idConsulta !== '0' && idConsulta !== '') {
                Swal.fire({
                    title: '¡Consulta Guardada!',
                    text: "¿Desea emitir una receta médica para este paciente?",
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonColor: '#208b3a', // Tu color verde
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="bi bi-file-earmark-medical me-1"></i> Sí, crear receta',
                    cancelButtonText: 'No, finalizar',
                    allowOutsideClick: false // Obliga al médico a decidir
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redirigimos a la vista de Receta pasando el ID de consulta
                        window.location.href = '@Url.Action("CrearReceta", "Citas")?idConsulta=' + idConsulta;
                    }
                });
            }
        });
    </script>
}