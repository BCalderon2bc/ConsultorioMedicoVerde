@model List<UsuarioViewModel>
@{
    ViewData["Title"] = "Gestión de Usuarios";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-verde fw-bold"><i class="bi bi-shield-lock-fill me-2"></i>Usuarios</h2>
    <a asp-action="Crear" class="btn btn-verde shadow-sm">
        <i class="bi bi-plus-lg"></i> Nuevo Usuario
    </a>
</div>

<div class="card shadow-sm border-0 mb-4 bg-light">
    <div class="card-body">
        <form asp-action="Index" method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold text-muted small">FILTRAR POR:</label>
                <select name="filtro" class="form-select border-success-subtle">
                    <option value="Nombre" selected="@(ViewBag.Filtro == "Nombre")">Nombre de Usuario</option>
                    <option value="Rol" selected="@(ViewBag.Filtro == "Rol")">Rol del Sistema</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold text-muted small">BUSCAR USUARIO:</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search text-success"></i></span>
                    <input type="text" name="buscar" class="form-control border-start-0"
                           placeholder="Escriba aquí o deje vacío para ver todos..." value="@ViewBag.Buscar">
                </div>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-verde w-100 shadow-sm">
                    <i class="bi bi-funnel-fill me-1"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

@if (Model != null && Model.Any())
{
    <div class="d-flex justify-content-end mb-3">
        <div class="d-flex align-items-center border p-2 rounded bg-white shadow-sm">
            <div class="form-check form-switch">
                @* Sincronizamos el estado del switch con el ViewBag enviado desde el controlador *@
                <input class="form-check-input border-success" type="checkbox" role="switch" id="filtrarActivos"
                       onchange="ejecutarFiltro(this)" @(ViewBag.MostrarActivos != false ? "checked" : "")>
                <label class="form-check-label fw-bold text-success" for="filtrarActivos" id="labelFiltro">
                    @(ViewBag.MostrarActivos != false ? "activos" : "inactivos")
                </label>
            </div>
        </div>
    </div>
}

<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Vínculo Médico</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        <tr class="usuario-fila" data-estado="@(item.Activo ? "activo" : "inactivo")">
                            <td>
                                <div class="fw-bold"><i class="bi bi-person-circle me-2 text-secondary"></i>@item.NombreUsuario</div>
                                <small class="text-muted">Última mod: @(item.FechaModificacion?.ToString("dd/MM/yyyy") ?? "N/A")</small>
                            </td>
                            <td>
                                <span class="badge @(item.Rol == "Admin" ? "bg-dark" : item.Rol == "Medico" ? "bg-primary" : "bg-info text-dark")">
                                    @item.Rol
                                </span>
                            </td>
                            <td>
                                @if (item.IdMedico > 0)
                                {
                                    <span class="badge bg-light text-success border border-success-subtle">
                                        <i class="bi bi-hospital me-1"></i> ID Med: @item.IdMedico
                                    </span>
                                }
                                else
                                {

                                    <span class="text-muted small">N/A</span>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge rounded-pill @(item.Activo ? "bg-success" : "bg-danger")">
                                    @(item.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group shadow-sm">
                                    <a asp-action="Editar" asp-route-id="@item.IdUsuario" class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm @(item.Activo ? "btn-outline-danger" : "btn-outline-success")"
                                            title="@(item.Activo ? "Desactivar" : "Activar")"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal"
                                            onclick="llenarDatosModal('@item.IdUsuario', '@item.NombreUsuario', @(item.Activo ? "true" : "false"))">
                                        <i class="bi @(item.Activo ? "bi-trash" : "bi-check-circle")"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="text-muted">
                                @if (ViewBag.Buscar == null)
                                {
                                    <i class="bi bi-shield-lock h1 d-block mb-3 text-verde opacity-50"></i>
                                    <h5 class="fw-bold text-verde">Gestión de Usuarios</h5>
                                    <p>Por favor, utilice el buscador o presione <b>Filtrar</b> para cargar la lista.</p>
                                }
                                else
                                {
                                    <i class="bi bi-search h1 d-block mb-3"></i>
                                    <p class="mb-0">No se encontraron usuarios que coincidan con "<b>@ViewBag.Buscar</b>".</p>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@* Modal de Acción Dinámico *@
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div id="modalHeaderColor" class="modal-header text-white">
                <h5 class="modal-title" id="modalTitulo">Confirmar Acción</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="CambiarEstado" method="post">
                <input type="hidden" name="id" id="idUsuarioEliminar" />
                <input type="hidden" name="activo" id="estadoUsuarioActualizar" />

                @* Hiddens para persistencia de filtros y estado del switch *@
                <input type="hidden" name="buscarActual" id="buscarActual" />
                <input type="hidden" name="filtroActual" id="filtroActual" />
                <input type="hidden" name="mostrarActivos" id="mostrarActivosActual" />

                <div class="modal-body text-center p-4">
                    <p class="fs-5">¿Está seguro de realizar esta acción para el usuario?</p>
                    <h4 id="nombreUsuarioEliminar" class="text-verde fw-bold"></h4>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" id="btnConfirmarModal" class="btn px-4">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function llenarDatosModal(id, nombre, estaActivo) {
            const inputId = document.getElementById('idUsuarioEliminar');
            const inputEstado = document.getElementById('estadoUsuarioActualizar');
            const labelNombre = document.getElementById('nombreUsuarioEliminar');
            const titulo = document.getElementById('modalTitulo');
            const header = document.getElementById('modalHeaderColor');
            const btnConfirmar = document.getElementById('btnConfirmarModal');

            // Capturar filtros actuales
            const inputBusqueda = document.querySelector('input[name="buscar"]');
            const selectFiltro = document.querySelector('select[name="filtro"]');
            const switchFiltro = document.getElementById('filtrarActivos');

            if (inputId && inputEstado) {
                inputId.value = id;
                labelNombre.innerText = nombre;

                // Sincronizar valores actuales para el POST
                document.getElementById('buscarActual').value = inputBusqueda ? inputBusqueda.value : "";
                document.getElementById('filtroActual').value = selectFiltro ? selectFiltro.value : "";
                document.getElementById('mostrarActivosActual').value = switchFiltro ? switchFiltro.checked : true;

                if (estaActivo) {
                    inputEstado.value = false;
                    titulo.innerHTML = '<i class="bi bi-person-x-fill me-2"></i>Desactivar Usuario';
                    header.className = "modal-header bg-danger text-white";
                    btnConfirmar.className = "btn btn-danger px-4";
                    btnConfirmar.innerText = "Confirmar y Desactivar";
                } else {
                    inputEstado.value = true;
                    titulo.innerHTML = '<i class="bi bi-person-check-fill me-2"></i>Reactivar Usuario';
                    header.className = "modal-header bg-success text-white";
                    btnConfirmar.className = "btn btn-success px-4";
                    btnConfirmar.innerText = "Confirmar y Activar";
                }
            }
        }

        function ejecutarFiltro(checkbox) {
            const mostrarSoloActivos = checkbox.checked;
            const label = document.getElementById('labelFiltro');
            const filas = document.getElementsByClassName('usuario-fila');

            if (label) {
                label.innerText = mostrarSoloActivos ? "activos" : "inactivos";
                label.className = "form-check-label fw-bold " + (mostrarSoloActivos ? "text-success" : "text-danger");
            }

            for (let i = 0; i < filas.length; i++) {
                const estado = filas[i].getAttribute('data-estado');
                if (mostrarSoloActivos) {
                    if (estado === "inactivo") filas[i].classList.add('ocultar-usuario');
                    else filas[i].classList.remove('ocultar-usuario');
                } else {
                    if (estado === "activo") filas[i].classList.add('ocultar-usuario');
                    else filas[i].classList.remove('ocultar-usuario');
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const switchFiltro = document.getElementById('filtrarActivos');
            // Ejecutamos el filtro inicial basado en el estado del switch (que persiste gracias al ViewBag)
            if (switchFiltro) ejecutarFiltro(switchFiltro);

            window.setTimeout(function() {
                $(".alert").fadeTo(500, 0).slideUp(500);
            }, 4000);
        });
    </script>
}